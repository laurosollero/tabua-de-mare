<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#1976d2" />
    <meta name="description" content="T√°bua de mar√©s para Jo√£o Pessoa, Para√≠ba" />
    <title>Mar√© em Jo√£o Pessoa</title>

    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        margin: 0;
        padding: 1rem;
        background: #f0f8ff;
        color: #333;
      }
      .container {
        max-width: 480px;
        margin: auto;
      }
      h1 {
        font-size: 1.4rem;
        color: #1976d2;
        margin-bottom: 0.5rem;
      }
      .subtitle {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 1rem;
      }
      input[type="date"] {
        padding: 0.5rem;
        font-size: 1rem;
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        background: #fff;
        color: #333;
      }
      .chart-container {
        background: #fff;
        border-radius: 12px;
        padding: 1rem;
        margin-top: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .current-estimate {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-radius: 12px;
        padding: 1rem;
        margin-top: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
      }
      .current-estimate .time {
        font-size: 0.85rem;
        color: #666;
      }
      .current-estimate .height {
        font-size: 2rem;
        font-weight: bold;
        color: #1976d2;
      }
      .current-estimate .trend {
        font-size: 1rem;
        margin-top: 0.25rem;
      }
      .trend.rising {
        color: #2e7d32;
      }
      .trend.falling {
        color: #c62828;
      }
      .tide-list {
        margin-top: 1rem;
      }
      .tide-entry {
        background: #fff;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-top: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .tide-entry .left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .tide-entry .icon {
        font-size: 1.5rem;
      }
      .tide-entry .time {
        font-weight: 600;
        color: #333;
      }
      .tide-entry .height {
        font-weight: 600;
        color: #1976d2;
      }
      .tide-entry.high {
        border-left: 3px solid #1976d2;
      }
      .tide-entry.low {
        border-left: 3px solid #ff9800;
      }
      .loading, .error {
        text-align: center;
        padding: 2rem;
        color: #666;
      }
      .error {
        color: #c62828;
      }
      .next-tide {
        background: #fff3e0;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-top: 1rem;
        text-align: center;
        font-size: 0.9rem;
      }
      .next-tide strong {
        color: #e65100;
      }
    </style>
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
  </head>
  <body>
    <div class="container">
      <h1>T√°bua de Mar√©</h1>
      <p class="subtitle">Jo√£o Pessoa, Para√≠ba</p>

      <label for="day-picker">Selecione o dia:</label>
      <input type="date" id="day-picker" />

      <div id="current-estimate"></div>
      <div id="next-tide"></div>

      <div class="chart-container">
        <canvas id="tide-chart" height="200"></canvas>
      </div>

      <div id="tides" class="tide-list"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      let tideData = [];
      let tideChart = null;

      const tidesEl = document.getElementById("tides");
      const dayPicker = document.getElementById("day-picker");
      const currentEstimateEl = document.getElementById("current-estimate");
      const nextTideEl = document.getElementById("next-tide");
      const chartCanvas = document.getElementById("tide-chart");

      function formatTime(date) {
        return date.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
      }

      function formatDuration(ms) {
        const hours = Math.floor(ms / (1000 * 60 * 60));
        const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
        if (hours > 0) {
          return `${hours}h ${minutes}min`;
        }
        return `${minutes}min`;
      }

      function interpolateTide(t1, h1, t2, h2, now) {
        const pct = (now - t1) / (t2 - t1);
        return h1 + (h2 - h1) * 0.5 * (1 - Math.cos(Math.PI * pct));
      }

      function generateChartData(tides, selectedDate) {
        const labels = [];
        const data = [];
        const pointColors = [];
        const now = new Date();
        const isToday = selectedDate === now.toISOString().split("T")[0];

        // Generate points every 15 minutes for smooth curve
        const dayStart = new Date(selectedDate + "T00:00:00");
        const dayEnd = new Date(selectedDate + "T23:59:59");

        for (let i = 0; i < tides.length - 1; i++) {
          const t1 = new Date(tides[i].datetime);
          const t2 = new Date(tides[i + 1].datetime);
          const h1 = tides[i].height;
          const h2 = tides[i + 1].height;

          // Add the tide point itself
          if (t1 >= dayStart) {
            labels.push(formatTime(t1));
            data.push(h1);
            pointColors.push("#1976d2");
          }

          // Add interpolated points
          let current = new Date(t1.getTime() + 15 * 60 * 1000);
          while (current < t2 && current <= dayEnd) {
            labels.push(formatTime(current));
            data.push(interpolateTide(t1, h1, t2, h2, current));
            pointColors.push("transparent");
            current = new Date(current.getTime() + 15 * 60 * 1000);
          }
        }

        // Add last tide point
        if (tides.length > 0) {
          const lastTide = tides[tides.length - 1];
          const lastTime = new Date(lastTide.datetime);
          if (lastTime <= dayEnd) {
            labels.push(formatTime(lastTime));
            data.push(lastTide.height);
            pointColors.push("#1976d2");
          }
        }

        return { labels, data, pointColors };
      }

      function renderChart(tides, selectedDate) {
        const { labels, data, pointColors } = generateChartData(tides, selectedDate);
        const now = new Date();
        const isToday = selectedDate === now.toISOString().split("T")[0];

        if (tideChart) {
          tideChart.destroy();
        }

        const ctx = chartCanvas.getContext("2d");

        // Find current time index for annotation
        let currentIndex = -1;
        if (isToday) {
          const nowTime = formatTime(now);
          currentIndex = labels.findIndex((l, i) => {
            if (i === labels.length - 1) return true;
            return l <= nowTime && labels[i + 1] > nowTime;
          });
        }

        tideChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: "Altura da mar√© (m)",
              data,
              borderColor: "#1976d2",
              backgroundColor: "rgba(25, 118, 210, 0.1)",
              fill: true,
              tension: 0.4,
              pointRadius: data.map((_, i) => pointColors[i] === "#1976d2" ? 6 : 0),
              pointBackgroundColor: pointColors,
              pointBorderColor: pointColors.map(c => c === "#1976d2" ? "#fff" : "transparent"),
              pointBorderWidth: 2,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.parsed.y.toFixed(2)} m`
                }
              }
            },
            scales: {
              x: {
                display: true,
                ticks: {
                  maxTicksLimit: 6,
                  font: { size: 11 }
                },
                grid: { display: false }
              },
              y: {
                display: true,
                min: 0,
                max: 3,
                ticks: {
                  stepSize: 0.5,
                  font: { size: 11 },
                  callback: (value) => value + " m"
                },
                grid: { color: "rgba(0,0,0,0.05)" }
              }
            }
          }
        });
      }

      function showCurrentEstimate(tides) {
        const now = new Date();

        for (let i = 0; i < tides.length - 1; i++) {
          const t1 = new Date(tides[i].datetime);
          const t2 = new Date(tides[i + 1].datetime);

          if (now >= t1 && now <= t2) {
            const h1 = tides[i].height;
            const h2 = tides[i + 1].height;
            const estimate = interpolateTide(t1, h1, t2, h2, now);
            const isRising = h2 > h1;

            currentEstimateEl.innerHTML = `
              <div class="current-estimate">
                <div class="time">Agora (${formatTime(now)})</div>
                <div class="height">${estimate.toFixed(2)} m</div>
                <div class="trend ${isRising ? 'rising' : 'falling'}">
                  ${isRising ? '‚Üë subindo' : '‚Üì descendo'}
                </div>
              </div>
            `;
            return;
          }
        }

        currentEstimateEl.innerHTML = "";
      }

      function showNextTide(tides) {
        const now = new Date();

        for (const tide of tides) {
          const tideTime = new Date(tide.datetime);
          if (tideTime > now) {
            const diff = tideTime - now;
            const isHigh = tide.height >= 1.5;
            nextTideEl.innerHTML = `
              <div class="next-tide">
                Pr√≥xima mar√© <strong>${isHigh ? 'alta' : 'baixa'}</strong> em
                <strong>${formatDuration(diff)}</strong> (${formatTime(tideTime)})
              </div>
            `;
            return;
          }
        }

        nextTideEl.innerHTML = "";
      }

      function showTidesFor(date) {
        const tides = tideData
          .filter((t) => t.datetime.startsWith(date))
          .sort((a, b) => new Date(a.datetime) - new Date(b.datetime));

        if (tides.length === 0) {
          tidesEl.innerHTML = '<div class="error">Sem dados dispon√≠veis para esta data.</div>';
          currentEstimateEl.innerHTML = "";
          nextTideEl.innerHTML = "";
          if (tideChart) {
            tideChart.destroy();
            tideChart = null;
          }
          return;
        }

        const today = new Date().toISOString().split("T")[0];
        const isToday = date === today;

        if (isToday) {
          showCurrentEstimate(tides);
          showNextTide(tides);
        } else {
          currentEstimateEl.innerHTML = "";
          nextTideEl.innerHTML = "";
        }

        renderChart(tides, date);

        tidesEl.innerHTML = tides
          .map((t) => {
            const time = new Date(t.datetime);
            const isHigh = t.height >= 1.5;
            const icon = isHigh ? "üåä" : "üåô";
            return `
              <div class="tide-entry ${isHigh ? 'high' : 'low'}">
                <div class="left">
                  <span class="icon">${icon}</span>
                  <span class="time">${formatTime(time)}</span>
                </div>
                <span class="height">${t.height.toFixed(2)} m</span>
              </div>
            `;
          })
          .join("");
      }

      dayPicker.addEventListener("change", () => {
        showTidesFor(dayPicker.value);
      });

      // Load tide data
      fetch("tides.json")
        .then((res) => {
          if (!res.ok) throw new Error("Falha ao carregar dados");
          return res.json();
        })
        .then((data) => {
          tideData = data;
          const dates = tideData.map((t) => t.datetime.split("T")[0]);
          const uniqueDates = [...new Set(dates)].sort((a, b) => new Date(a) - new Date(b));

          if (uniqueDates.length === 0) {
            tidesEl.innerHTML = '<div class="error">Nenhum dado de mar√© dispon√≠vel.</div>';
            return;
          }

          const today = new Date().toISOString().split("T")[0];
          dayPicker.min = uniqueDates[0];
          dayPicker.max = uniqueDates[uniqueDates.length - 1];
          dayPicker.value = uniqueDates.includes(today) ? today : uniqueDates[0];
          showTidesFor(dayPicker.value);
        })
        .catch((err) => {
          tidesEl.innerHTML = `<div class="error">Erro ao carregar os dados da mar√©.<br><small>${err.message}</small></div>`;
          console.error(err);
        });

      // Register service worker
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/sw.js").catch(console.error);
      }
    </script>
  </body>
</html>
