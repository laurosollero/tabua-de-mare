<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#1976d2" />
    <title>Mar√© em Jo√£o Pessoa</title>

    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 1rem;
        background: #f0f8ff;
        color: #333;
      }
      .container {
        max-width: 480px;
        margin: auto;
      }
      h1 {
        font-size: 1.5rem;
        color: #1976d2;
      }
      input[type="date"] {
        margin-top: 1rem;
        padding: 0.5rem;
        font-size: 1rem;
        width: 100%;
        max-width: 97%;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        background: #fff;
        color: #333;
      }
      .tide-entry {
        background: #fff;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .loading {
        color: #888;
      }
    </style>
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
  </head>
  <body>
    <div class="container">
      <h1>T√°bua de Mar√© - Jo√£o Pessoa</h1>
      <label for="day-picker">Selecione o dia:</label>
      <input type="date" id="day-picker" />
      <div id="tides" class="loading">Carregando dados da mar√©...</div>
    </div>

    <script>
      // Os dados ser√£o carregados de tides-2025.json
      let tideData = [];

      const tidesEl = document.getElementById("tides");
      const dayPicker = document.getElementById("day-picker");

      function populateDaySelector() {
        const uniqueDates = [
          ...new Set(tideData.map((t) => t.datetime.split("T")[0])),
        ].sort((a, b) => new Date(a) - new Date(b));
        uniqueDates.forEach((date) => {
          const opt = document.createElement("option");
          opt.value = date;
          opt.textContent = new Date(date).toLocaleDateString("pt-BR", {
            weekday: "long",
            day: "2-digit",
            month: "long",
          });
          daySelect.appendChild(opt);
        });
      }

      function showTidesFor(date) {
        const tides = tideData
          .filter((t) => t.datetime.startsWith(date))
          .sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
        if (tides.length === 0) {
          tidesEl.innerHTML = "Sem dados dispon√≠veis para esta data.";
          return;
        }

        const now = new Date();
        const nowStr = now.toISOString();

        let estimate = null;
        let estimateTime = null;
        let trend = "";
        for (let i = 0; i < tides.length - 1; i++) {
          const t1 = new Date(tides[i].datetime);
          const t2 = new Date(tides[i + 1].datetime);
          if (now >= t1 && now <= t2) {
            const h1 = tides[i].height;
            const h2 = tides[i + 1].height;
            const pct = (now - t1) / (t2 - t1);
            const interp = h1 + (h2 - h1) * 0.5 * (1 - Math.cos(Math.PI * pct));
            estimate = interp.toFixed(2);
            estimateTime = now.toLocaleTimeString("pt-BR", {
              hour: "2-digit",
              minute: "2-digit",
            });
            trend = h2 > h1 ? "‚¨Ü subindo" : "‚¨á descendo";
            break;
          }
        }

        let estimateHtml = "";
        if (estimate) {
          estimateHtml = `<div class="tide-entry" style="background:#e0f7ff;font-weight:bold;">üìç Mar√© estimada √†s ${estimateTime}: ${estimate} m <span style='float:right;'>${trend}</span></div>`;
        }
        tidesEl.innerHTML =
          estimateHtml +
          tides
            .map((t) => {
              const time = new Date(t.datetime).toLocaleTimeString("pt-BR", {
                hour: "2-digit",
                minute: "2-digit",
              });
              const icon = t.height >= 2 ? "üåä" : t.height <= 0.5 ? "üåò" : "üåÖ";
              return `<div class="tide-entry">${icon} <strong>${time}</strong>: ${t.height.toFixed(
                2
              )} m</div>`;
            })
            .join("");
      }

      dayPicker.addEventListener("change", () => {
        showTidesFor(dayPicker.value);
      });

      fetch("tides-2025.json")
        .then((res) => res.json())
        .then((data) => {
          tideData = data;
          const dates = tideData.map((t) => t.datetime.split("T")[0]);
          const uniqueDates = [...new Set(dates)].sort(
            (a, b) => new Date(a) - new Date(b)
          );
          const today = new Date().toISOString().split("T")[0];
          dayPicker.min = uniqueDates[0];
          dayPicker.max = uniqueDates[uniqueDates.length - 1];
          dayPicker.value = uniqueDates.includes(today)
            ? today
            : uniqueDates[0];
          showTidesFor(dayPicker.value);
        })
        .catch((err) => {
          tidesEl.innerHTML = "Erro ao carregar os dados da mar√©.";
          console.error(err);
        });

      if ("serviceWorker" in navigator) {
        fetch("sw.js")
          .then((response) => {
            if (response.ok) {
              navigator.serviceWorker.register("sw.js").catch(console.error);
            } else {
              console.warn(
                "Service worker n√£o encontrado. Ignorando registro."
              );
            }
          })
          .catch((err) => {
            console.warn("Erro ao verificar service worker:", err);
          });
      }
    </script>
  </body>
</html>
